# 黑马旅游网项目遇到的问题及解决

## 项目配置问题

【maven项目目录结构】

可能一开始创建出来的项目文件目录形式不对，IDEA对目录结构有明显的要求，可以通过以下方法修改，当然其他情况也可以使用;

![image-20200326232605666](C:\Users\13327\AppData\Roaming\Typora\typora-user-images\image-20200326232605666.png)

【修改目录属性】

![mvn](E:\1JavaBlog\maven\pic\mvn.png)

后来发现可以直接右键点击目录，选择make directory as 效果是一样的。

![image-20200327125444781](C:\Users\13327\AppData\Roaming\Typora\typora-user-images\image-20200327125444781.png)

【设置web源目录】

![websource](E:\1JavaBlog\maven\pic\websource.png)

【maven低版本和servlet3.0冲突】

视频中使用的是Servlet3.0之后的版本，利用注解配置，我原来之前一直也是注解配置，想试着使用xml配置练练手。但是当我从xml到注解转换的过程中，遇到了一些问题，主要是Servlet版本和maven仓库版本冲突？具体我也不太清清除，过于真实，整个过程迷迷糊糊的，bug频出，也试过很多方法，真的不知道是哪个方法起了作用。

以下内容仅记录自己的纠错过程，首先我先去视频中的代码文件查看一下有偏差的地方：直接锁定是Servlet的版本问题，servlet3.0之后才可以使用注解，而我使用的是2.5。

接着，我参考了这个博客：[Maven创建webapp骨架无法使用@WebServlet来实现注解配置解决方案](https://blog.csdn.net/qq_41753944/article/details/103899701)，修改了maven仓库中的jar包的web.xml内容，可能是我操作的问题，并没有见效。

接着又在某个论坛上看到一个方法，可以重新指定xml的版本。【后面测试了几次，貌似和这个关系不大】

![image-20200327124757985](C:\Users\13327\AppData\Roaming\Typora\typora-user-images\image-20200327124757985.png)

![image-20200327124807705](C:\Users\13327\AppData\Roaming\Typora\typora-user-images\image-20200327124807705.png)

接着在pom.xml中添加servlet3.0之后的依赖，需要注意的是，要指定scope为provide，不然的话可能会产生冲突。【一定要注意找到填写正确坐标，有一次我把artifactId里写成servlet-api死活下载不来】

```xml
        <!--Servlet-->
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>3.1.0</version>
            <scope>provided</scope>
        </dependency>
```

就像这样的冲突错误（下面两种都是因为scope没有指定privided的原因，因为添加上去就成功了）

`com.travel.web.filter.CharacterFilter cannot be cast to javax.servlet.Filter`。

`javax.servlet.ServletException: java.lang.LinkageError`。

中途会遇到缺少javaEE啥啥啥的，annotation包依赖缺少的错误，按照提示添加即可。

以上就是我从web.xml到注解配置的全过程，有点坎坷，但是今后遇到这样的问题，兴许会多一些思路吧。

【控制台输出乱码解决】

![image-20200327221444893](C:\Users\13327\AppData\Roaming\Typora\typora-user-images\image-20200327221444893.png)

`settings`->`Build,Execution,Deployment`->`Build Tools`->`Maven`->`Runner`。

设置`VM-Option`参数，指定虚拟机字符集：`-Dfile.encoding=gb2312`，如果不行可以设置称其他的。

# 前台代码

【发送异步请求】

```js
//校验通过,ajax发送请求,提交表单数据  $("#registerForm").serialize()
$.post("registerUserServlet",$(this).serialize(),function (data) {

    if(data.flag){
        //注册成功,跳转成功页面
        location.href= "register_ok.html";
    }else{
        //如果错误,需要重新对验证码servlet请求一次,不然会导致会话中的验证码消失,图片虽然存在,但码已经没有了
		document.getElementById("check_img").src= "checkCode?"+new Date().getTime();
        //注册失败,给errormsg添加提示信息
        $("#error_msg").html(data.errorMsg);
    }
})
```

【校验手机号格式】

```js
var reg_telephone = /^1(3|4|5|7|8)\d{9}$/;
```

【校验邮箱格式】

```js
var reg_email = /^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
```

【失去焦点事件】，注意此时将函数名作为Function对象传入，没有()。

```js
$("#username").blur(checkUsername);
```

涉及到【前后端交互】，将信息封装为对象，是值得我学习的地方。

```java
public class ResultInfo implements Serializable {
    private boolean flag;//后端返回结果正常为true，发生异常返回false
    private Object data;//后端返回结果数据对象
    private String errorMsg;//发生异常的错误消息
}
```

利用【jackson】操作json数据

```java
import com.fasterxml.jackson.databind.ObjectMapper;

//将info对象序列化为json,返回客户端
ObjectMapper mapper = new ObjectMapper();
String json = mapper.writeValueAsString(info);
//将json数据写回客户端
//设置content-type
response.setContentType("application/json;charset=utf-8");
response.getWriter().write(json);
```

利用【MailUtils】完成邮箱发送，不过得在邮箱设置里面申请开启服务。

利用【uuid工具类】完成随机激活码的生成。

【分发Servlet】

```java
try {
    Method method = this.getClass().getMethod(methodName, HttpServletRequest.class, HttpServletResponse.class);
    //调用方法
    method.invoke(this,req,resp);

} catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {
    e.printStackTrace();
}
```

报错：`java.lang.NoSuchMethodException`

原因：调用方法是Protected修饰的。

解决：

1. 忽略访问权限修饰符+暴力破解。

   ```java
   try {
       //忽略访问权限修饰符
       Method method = this.getClass().getDeclaredMethod(methodName, HttpServletRequest.class, HttpServletResponse.class);
       //暴力破解
       method.setAccessible(true);
       //调用方法
       method.invoke(this,req,resp);
   
   } catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {
       e.printStackTrace();
   }
   ```

2. 直接将调用的方法权限修改为public即可。（看到这操作，忍不住笑了）

## 其他优化

【Alibaba Java Coding Guidelines】

这个插件下载之后，才发现自己原来写的注释那么没有原则，哈哈，这个东西对于有强迫症的人来说，简直魔鬼无疑。

【抽取了验证码校验功能】

```java
    private boolean checkCode(HttpServletRequest request,HttpServletResponse response) throws IOException {
        //验证码校验
        String check = request.getParameter("check");

        HttpSession session = request.getSession();
        String checkCodeServer = (String) session.getAttribute("checkCode");

        //保证验证码只能使用一次
        session.removeAttribute("checkCode");
        //验证码不相等
        if(checkCodeServer == null||!checkCodeServer.equalsIgnoreCase(check)){
			//对用户输入验证码进行判断
            if("".equals(check)){
                info.setErrorMsg("验证码不能为空");
            }else {
                info.setErrorMsg("验证码错误");
            }
            info.setFlag(false);
            response.setContentType(JSON_CONTENT_TYPE);
            String s = mapper.writeValueAsString(info);
            response.getWriter().write(s);
            return false;
        }
        return true;
    }
```

【缓存优化】

有些资源每次加载页面都会重新请求数据库数据来加载，对数据库的压力比较大，且这些数据不会经常发生变化，可以进行缓存优化。





